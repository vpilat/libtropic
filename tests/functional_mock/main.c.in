/**
 * @file main.c
 * @brief Main file for running functional mock tests.
 * @copyright Copyright (c) 2020-2025 Tropic Square s.r.o.
 *
 * @license For the license see file LICENSE.txt file in the root directory of this source tree.
 */

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>

#include "libtropic.h"
#include "libtropic_logging.h"
#include "libtropic_macros.h"
#include "libtropic_mbedtls_v4.h"
#include "libtropic_port_mock.h"

#include "lt_functional_mock_tests.h"

int main(void)
{
    // Disable buffering on stdout/stderr to simplify CI logs.
    LT_UNUSED(setvbuf(stdout, NULL, _IONBF, 0));
    LT_UNUSED(setvbuf(stderr, NULL, _IONBF, 0));

    psa_status_t status = psa_crypto_init();
    if (status != PSA_SUCCESS) {
        LT_LOG_ERROR("PSA Crypto initialization failed, status=%" PRId32 " (psa_status_t)", status);
        return -1;
    }

    lt_handle_t __lt_handle__ = {0};
#if LT_SEPARATE_L3_BUFF
    // Provide an l3 buffer when separate L3 buffer is used.
    uint8_t l3_buffer[LT_SIZE_OF_L3_BUFF] __attribute__((aligned(16))) = {0};
    __lt_handle__.l3.buff = l3_buffer;
    __lt_handle__.l3.buff_len = sizeof(l3_buffer);
#endif

    lt_dev_mock_t mock_device = {0};
    __lt_handle__.l2.device = &mock_device;
    lt_mock_hal_reset(&__lt_handle__.l2);

    lt_ctx_mbedtls_v4_t crypto_ctx;
    __lt_handle__.l3.crypto_ctx = &crypto_ctx;

    // Seed PRNG similarly to integration main so tests are reproducible when desired.
    unsigned int prng_seed = 0;
    LT_UNUSED(getentropy(&prng_seed, sizeof(prng_seed)));
    srand(prng_seed);
    LT_LOG_INFO("PRNG initialized with seed=%u", prng_seed);

    // Call the test function (each test will call lt_init() itself).
    @LIBTROPIC_MOCK_TEST_FUNCTION@(&__lt_handle__);

    mbedtls_psa_crypto_free();

    LT_LOG_INFO("Test finished!");

    return 0;
}
